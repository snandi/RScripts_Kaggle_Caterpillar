################################################################################################
### To explore the relationship between basis price (at quantity=1) and tubes properties
#######################################################################################################

source(paste(RScriptPath, 'RScript01_Prepare_trainset.R', sep=''))

# Have quite figured out how to fit yet
## issues:
#  1, We want to get a data set with price corresponding to quantity =1, but some tube_assembly_id/ instance has prices from a higher quantity.
#  2, some factor variables have a lot of levels:  supplier: Factor w/ 57 levels , end_a, end_x have round 30 levesls. Difficult to intepret.
#  3, Missing issues, it seems that There are 10% missing for component type. 1 % missing for material_id.


str(Data)
# 'data.frame':  30213 obs. of  54 variables:
#   $ tube_assembly_id  : Factor w/ 8855 levels "TA-00002","TA-00004",..: 1 1 1 1 1 1 1 1 2 2 ...
# $ supplier          : Factor w/ 57 levels "S-0003","S-0004",..: 37 37 37 37 37 37 37 37 37 37 ...
# $ quote_date        : Factor w/ 1781 levels "1982-09-22","1987-04-10",..: 1518 1518 1518 1518 1518 1518 1518 1518 1518 1518 ...
# $ annual_usage      : int  0 0 0 0 0 0 0 0 0 0 ...
# $ min_order_quantity: int  0 0 0 0 0 0 0 0 0 0 ...
# $ bracket_pricing   : Factor w/ 2 levels "No","Yes": 2 2 2 2 2 2 2 2 2 2 ...
# $ quantity          : int  5 100 50 10 250 2 25 1 10 5 ...
# $ cost              : num  6.6 3.08 3.22 4.69 3 ...
# $ train_id          : int [1:30213, 1:8] 3 7 6 4 8 2 5 1 12 11 ...
# $ material_id       : Factor w/ 19 levels "SP-0008","SP-0019",..: 2 2 2 2 2 2 2 2 2 2 ...
# $ diameter          : num  6.35 6.35 6.35 6.35 6.35 6.35 6.35 6.35 6.35 6.35 ...
# $ wall              : num  0.71 0.71 0.71 0.71 0.71 0.71 0.71 0.71 0.71 0.71 ...
# $ length            : num  137 137 137 137 137 137 137 137 137 137 ...
# $ num_bends         : int  8 8 8 8 8 8 8 8 9 9 ...
# $ bend_radius       : num  19.1 19.1 19.1 19.1 19.1 ...
# $ end_a_1x          : Factor w/ 2 levels "N","Y": 1 1 1 1 1 1 1 1 1 1 ...
# $ end_a_2x          : Factor w/ 2 levels "N","Y": 1 1 1 1 1 1 1 1 1 1 ...
# $ end_x_1x          : Factor w/ 2 levels "N","Y": 1 1 1 1 1 1 1 1 1 1 ...
# $ end_x_2x          : Factor w/ 2 levels "N","Y": 1 1 1 1 1 1 1 1 1 1 ...
# $ end_a             : Factor w/ 25 levels "EF-001","EF-002",..: 8 8 8 8 8 8 8 8 8 8 ...
# $ end_x             : Factor w/ 27 levels "9999","EF-001",..: 9 9 9 9 9 9 9 9 9 9 ...
# $ num_boss          : int  0 0 0 0 0 0 0 0 0 0 ...
# $ num_bracket       : int  0 0 0 0 0 0 0 0 0 0 ...
# $ other             : int  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-001            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-002            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-003            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-004            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-005            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-006            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-007            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-008            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-009            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-010            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-011            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-012            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-014            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-015            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-016            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-017            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-018            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-019            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-020            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-021            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-022            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-023            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-024            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-025            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-026            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-027            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ CP-028            : num  2 2 2 2 2 2 2 2 2 2 ...
# $ CP-029            : num  0 0 0 0 0 0 0 0 0 0 ...
# $ OTHER             : num  0 0 0 0 0 0 0 0 0 0 ...
# $ log_ai            : num  2.03 1.41 1.44 1.74 1.39 ...

summary(Data$material_id)
Data$material_id <- as.factor(Data$material_id) 
# SP-0008 SP-0019 SP-0028 SP-0029 SP-0030 SP-0031 SP-0032 SP-0033 SP-0034 SP-0035 SP-0036 SP-0037 SP-0038 SP-0039 SP-0041 SP-0044 SP-0045 SP-0046 SP-0048 
# 50    2652    1654   16165      22       2       4     102      16    5697      48     397     139    2852      43       0       0      87      54 
# NA's 
# 229 
#19 levels



length(unique(Data$tube_assembly_id)) 
# 8855

NewData1 <- subset(Data,quantity==1)  # suset of base line price, price at unit 1.
nrow(NewData1) # 7061 some product quantity >1.

nrow(TrainData)
plot(TrainData$quantity)
nrow(Data_MinQty) 
plot(Data_MinQty$quantity)


##processing on Data_MInQty
str(Data_MinQty$quote_date <- as.Date(Data_MinQty$quote_date))
#remove Data_MinQty$train_id is just  row_id 
Data_MinQty<- Data_MinQty[,-which(names(Data_MinQty)=="train_id")]
Data_MinQty<- Data_MinQty[,-which(names(Data_MinQty)=="tube_assembly_id")]
#factor variables, quite some ids, they take up degree
#

## missing values 
missing <- integer(ncol(NewData1))
for ( i  in 1:ncol(NewData1)){
  missing[i] <- sum(is.na(NewData1[,i]))
}
plot (missing)
names(NewData1)[which(missing > 50)]
# all from component_type variales



lm1 <- lm(log_ai ~ ., data =Data_MinQty)
summary(lm1)
anova(lm1)
# end_a, end_x have 25,27 levels respectively, suppliers have 57 levels. 
#result looks weird. But We don't need go too much into the intepretation.
nlevels(Data_MinQty$supplier)
nlevels(Data_MinQty$end_a)
nlevels(Data_MinQty$end_x)



############################################################################################################################
### predcition by combining thethe two parts togehter basis price and decline over quantity
### Need to creat corresponding Data_CostQty_Mult_D1//Data_MinQty for the test set, 
################################################################################################################################
BasePrice <- predict (lm1,  Data_MinQty.te)
deltaPrice <- predict (lm1,  Data_CostQty.te)
PredPrice <- BasePrcie + PredPrice
